# üìö –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ Bank-in-a-Box

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã](#–æ–±–∑–æ—Ä-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã)
2. [–°–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ credentials](#—Å–∏—Å—Ç–µ–º–∞-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏-–∏-credentials)
3. [–ú–µ–∂–±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∏ OpenBanking Flow](#–º–µ–∂–±–∞–Ω–∫–æ–≤—Å–∫–∏–µ-–∑–∞–ø—Ä–æ—Å—ã-–∏-openbanking-flow)
4. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –º–æ–¥–µ–ª–∏](#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö-–∏-–º–æ–¥–µ–ª–∏)
5. [API Endpoints –∏ –∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ](#api-endpoints-–∏-–∏—Ö-–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ)
6. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è-–∏-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ-–æ–∫—Ä—É–∂–µ–Ω–∏—è)
7. [–ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö (Data Flow)](#–ø–æ—Ç–æ–∫–∏-–¥–∞–Ω–Ω—ã—Ö-data-flow)
8. [–í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏](#–≤–∞–∂–Ω—ã–µ-–º–æ–º–µ–Ω—Ç—ã-–∏-–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏)

---

## üèóÔ∏è –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Bank-in-a-Box System                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  Frontend    ‚îÇ    ‚îÇ   FastAPI    ‚îÇ    ‚îÇ  PostgreSQL  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  (Client UI) ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Backend    ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Database   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  (Banker UI) ‚îÇ    ‚îÇ   (Python)   ‚îÇ    ‚îÇ              ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ         ‚îÇ                    ‚îÇ                              ‚îÇ
‚îÇ         ‚îÇ                    ‚îÇ                              ‚îÇ
‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ                              ‚îÇ                              ‚îÇ
‚îÇ                              ‚ñº                              ‚îÇ
‚îÇ                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                     ‚îÇ
‚îÇ                    ‚îÇ  External Banks  ‚îÇ                     ‚îÇ
‚îÇ                    ‚îÇ  (OpenBanking)   ‚îÇ                     ‚îÇ
‚îÇ                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                     ‚îÇ
‚îÇ                                                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **Backend**: FastAPI (Python 3.12+)
- **Database**: PostgreSQL 15+ (async —á–µ—Ä–µ–∑ asyncpg)
- **ORM**: SQLAlchemy 2.0 (async)
- **Authentication**: JWT (HS256 –¥–ª—è –∫–æ–º–∞–Ω–¥, RS256 –¥–ª—è –±–∞–Ω–∫–æ–≤)
- **HTTP Client**: httpx (–¥–ª—è –º–µ–∂–±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)
- **Frontend**: Vanilla JavaScript, HTML5, CSS3

---

## üîê –°–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ credentials

### –ß—Ç–æ —Ç–∞–∫–æ–µ TEAM_CLIENT_ID –∏ TEAM_CLIENT_SECRET?

**TEAM_CLIENT_ID** –∏ **TEAM_CLIENT_SECRET** ‚Äî —ç—Ç–æ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ —Ö–∞–∫–∞—Ç–æ–Ω–µ HackAPI 2025.

#### –û—Ç–∫—É–¥–∞ –±–µ—Ä—É—Ç—Å—è:

1. **–û—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤ —Ö–∞–∫–∞—Ç–æ–Ω–∞** ‚Äî –≤—ã–¥–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–º–∞–Ω–¥—ã
2. **–ß–µ—Ä–µ–∑ Developer Portal** ‚Äî –º–æ–∂–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ `/developer.html`
3. **–•—Ä–∞–Ω—è—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö** ‚Äî —Ç–∞–±–ª–∏—Ü–∞ `teams`

#### –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è:

**1. –í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (`config.py`):**
```python
TEAM_CLIENT_ID: Optional[str] = None      # –ò–∑ .env —Ñ–∞–π–ª–∞
TEAM_CLIENT_SECRET: Optional[str] = None   # –ò–∑ .env —Ñ–∞–π–ª–∞
```

**2. –í –º–µ–∂–±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö (`api/multibank_proxy.py`):**
```python
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –æ—Ç –¥—Ä—É–≥–∏—Ö –±–∞–Ω–∫–æ–≤
TEAM_CLIENT_ID = config.TEAM_CLIENT_ID or "team200"
TEAM_CLIENT_SECRET = config.TEAM_CLIENT_SECRET or "..."

# –ó–∞–ø—Ä–æ—Å –∫ –≤–Ω–µ—à–Ω–µ–º—É –±–∞–Ω–∫—É:
POST {bank_url}/auth/bank-token
?client_id={TEAM_CLIENT_ID}
&client_secret={TEAM_CLIENT_SECRET}
```

**3. –í –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –±–∞–Ω–∫–æ–≤ (`api/auth.py`):**
```python
# Endpoint: POST /auth/bank-token
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç credentials –≤ —Ç–∞–±–ª–∏—Ü–µ teams
# –í—ã–¥–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API –±–∞–Ω–∫–∞
```

#### –ó–∞—á–µ–º –Ω—É–∂–Ω—ã:

- **–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –±–∞–Ω–∫–∞** ‚Äî –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ API –¥—Ä—É–≥–∏—Ö –±–∞–Ω–∫–æ–≤
- **–ú–µ–∂–±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** ‚Äî –∑–∞–ø—Ä–æ—Å—ã –∫ —Å—á–µ—Ç–∞–º –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –¥—Ä—É–≥–∏—Ö –±–∞–Ω–∫–∞—Ö
- **–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã** ‚Äî –∫—Ç–æ –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å (–¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)

### –¢–∏–ø—ã —Ç–æ–∫–µ–Ω–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ

#### 1. **Team Token** (–¥–ª—è –∫–æ–º–∞–Ω–¥)
- **–ü–æ–ª—É—á–µ–Ω–∏–µ**: `POST /auth/bank-token?client_id=team200&client_secret=...`
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –ó–∞–ø—Ä–æ—Å—ã –∫ API –±–∞–Ω–∫–∞ –æ—Ç –∏–º–µ–Ω–∏ –∫–æ–º–∞–Ω–¥—ã
- **–ê–ª–≥–æ—Ä–∏—Ç–º**: HS256 (–¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –≤ sandbox)
- **–í–∞–ª–∏–¥–Ω–æ—Å—Ç—å**: 24 —á–∞—Å–∞
- **–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**: 
  - –ú–µ–∂–±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ `/multibank/*`
  - –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–∑ –¥—Ä—É–≥–∏—Ö –±–∞–Ω–∫–æ–≤

#### 2. **Client Token** (–¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤)
- **–ü–æ–ª—É—á–µ–Ω–∏–µ**: `POST /auth/login` (username + password)
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –î–æ—Å—Ç—É–ø –∫ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º —Å—á–µ—Ç–∞–º —á–µ—Ä–µ–∑ Client UI
- **–ê–ª–≥–æ—Ä–∏—Ç–º**: HS256
- **–í–∞–ª–∏–¥–Ω–æ—Å—Ç—å**: 24 —á–∞—Å–∞
- **–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**:
  - –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ (`/client/dashboard.html`)
  - –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–∏—Ö —Å—á–µ—Ç–æ–≤, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –ø—Ä–æ–¥—É–∫—Ç–æ–≤

#### 3. **Banker Token** (–¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –±–∞–Ω–∫–∞)
- **–ü–æ–ª—É—á–µ–Ω–∏–µ**: `POST /auth/banker-login` (admin/admin)
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–Ω–∫–æ–º —á–µ—Ä–µ–∑ Banker UI
- **–ê–ª–≥–æ—Ä–∏—Ç–º**: HS256
- **–í–∞–ª–∏–¥–Ω–æ—Å—Ç—å**: 24 —á–∞—Å–∞
- **–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è**:
  - –ö–∞–±–∏–Ω–µ—Ç –±–∞–Ω–∫–∏—Ä–∞ (`/banker/*`)
  - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏, –æ–¥–æ–±—Ä–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–∏–π, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –¢–∞–±–ª–∏—Ü–∞ `teams` –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

```sql
CREATE TABLE teams (
    id SERIAL PRIMARY KEY,
    client_id VARCHAR(100) UNIQUE NOT NULL,      -- team200, team201, etc.
    client_secret VARCHAR(255) NOT NULL,         -- –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –∫–æ–º–∞–Ω–¥—ã
    team_name VARCHAR(255),                      -- –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW()
);
```

**–ö–∞–∫ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è:**
- –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `/developer.html` ‚Üí `POST /auth/register-team`
- –í—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ SQL (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
- –ß–µ—Ä–µ–∑ `shared/database/init.sql` (–ø—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö)

---

## üåê –ú–µ–∂–±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∏ OpenBanking Flow

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞ —Å—á–µ—Ç–æ–≤ –∏–∑ –¥—Ä—É–≥–∏—Ö –±–∞–Ω–∫–æ–≤

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —Å—á–µ—Ç–∞ —Å –±–∞–Ω–∫–æ–≤", –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–ª–µ–¥—É—é—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å:

#### –®–ê–ì 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Ç–æ–∫–µ–Ω–∞

**Frontend** (`dashboard.html`):
```javascript
POST /multibank/bank-token
Body: { bank_url: "https://vbank.open.bankingapi.ru" }
```

**Backend** (`api/multibank_proxy.py`):
```python
# –î–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ –≤–Ω–µ—à–Ω–µ–º—É –±–∞–Ω–∫—É:
POST {bank_url}/auth/bank-token
Params:
  client_id={TEAM_CLIENT_ID}      # –ò–∑ config
  client_secret={TEAM_CLIENT_SECRET}  # –ò–∑ config
```

**–í–Ω–µ—à–Ω–∏–π –±–∞–Ω–∫** (`api/auth.py`):
```python
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç credentials –≤ —Ç–∞–±–ª–∏—Ü–µ teams
# –í—ã–¥–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω
# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: { "access_token": "eyJ...", ... }
```

#### –®–ê–ì 2: –ó–∞–ø—Ä–æ—Å —Å–æ–≥–ª–∞—Å–∏—è (Consent)

**Frontend**:
```javascript
POST /multibank/request-consent
Body: {
  bank_url: "https://vbank.open.bankingapi.ru",
  bank_token: "...",
  client_id: "team200-1"  // ID –∫–ª–∏–µ–Ω—Ç–∞ –≤ —Ü–µ–ª–µ–≤–æ–º –±–∞–Ω–∫–µ
}
```

**Backend** (`api/multibank_proxy.py`):
```python
# –î–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ –≤–Ω–µ—à–Ω–µ–º—É –±–∞–Ω–∫—É:
POST {bank_url}/account-consents/request
Headers:
  Authorization: Bearer {bank_token}
  x-requesting-bank: {TEAM_CLIENT_ID}
Body: {
  client_id: "team200-1",
  permissions: ["ReadAccountsDetail", "ReadBalances", ...]
}
```

**–í–Ω–µ—à–Ω–∏–π –±–∞–Ω–∫** (`api/consents.py`):
```python
# –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–≥–ª–∞—Å–∏–µ (ConsentRequest)
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫—É auto_approve_consents
# –ï—Å–ª–∏ auto_approve = true ‚Üí —Å—Ä–∞–∑—É —Å–æ–∑–¥–∞–µ—Ç Consent
# –ï—Å–ª–∏ auto_approve = false ‚Üí —Å–æ–∑–¥–∞–µ—Ç pending –∑–∞–ø—Ä–æ—Å
```

#### –®–ê–ì 3: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—á–µ—Ç–æ–≤ —Å —Å–æ–≥–ª–∞—Å–∏–µ–º

**Frontend**:
```javascript
POST /multibank/accounts-with-consent
Body: {
  bank_url: "https://vbank.open.bankingapi.ru",
  bank_token: "...",
  consent_id: "consent-abc123",
  client_id: "team200-1"
}
```

**Backend** (`api/multibank_proxy.py`):
```python
# –î–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ –≤–Ω–µ—à–Ω–µ–º—É –±–∞–Ω–∫—É:
GET {bank_url}/accounts?client_id=team200-1
Headers:
  Authorization: Bearer {bank_token}
  x-consent-id: {consent_id}
  x-requesting-bank: {TEAM_CLIENT_ID}
```

**–í–Ω–µ—à–Ω–∏–π –±–∞–Ω–∫** (`api/accounts.py`):
```python
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è:
consent = ConsentService.check_consent(
    client_person_id="team200-1",
    requesting_bank="team200",  # –ò–∑ x-requesting-bank
    permissions=["ReadAccountsDetail"]
)

# –ï—Å–ª–∏ —Å–æ–≥–ª–∞—Å–∏–µ –µ—Å—Ç—å ‚Üí —á–∏—Ç–∞–µ—Ç —Å—á–µ—Ç–∞ –∏–∑ –ë–î
# –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 403 CONSENT_REQUIRED
```

### –í–∞–∂–Ω–æ: –û—Ç–∫—É–¥–∞ –±–µ—Ä—É—Ç—Å—è –¥–∞–Ω–Ω—ã–µ?

**‚ùå –ù–ï –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö!**

**‚úÖ –ò–∑ API –≤–Ω–µ—à–Ω–∏—Ö –±–∞–Ω–∫–æ–≤ —á–µ—Ä–µ–∑ HTTP –∑–∞–ø—Ä–æ—Å—ã!**

1. –í–∞—à –±–∞–Ω–∫ –¥–µ–ª–∞–µ—Ç HTTP –∑–∞–ø—Ä–æ—Å –∫ `https://vbank.open.bankingapi.ru/accounts`
2. –í–Ω–µ—à–Ω–∏–π –±–∞–Ω–∫ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–≥–ª–∞—Å–∏–µ –≤ **—Å–≤–æ–µ–π** –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
3. –í–Ω–µ—à–Ω–∏–π –±–∞–Ω–∫ —á–∏—Ç–∞–µ—Ç —Å—á–µ—Ç–∞ –∏–∑ **—Å–≤–æ–µ–π** –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
4. –í–Ω–µ—à–Ω–∏–π –±–∞–Ω–∫ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ API
5. –í–∞—à –±–∞–Ω–∫ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≤–æ frontend

**–õ–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è:**
- –•—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–∏–π (consents) –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –≤–∞—à–µ–º—É –±–∞–Ω–∫—É
- –•—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ —Å—á–µ—Ç–æ–≤
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è API –≤—ã–∑–æ–≤–æ–≤

---

## üíæ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –º–æ–¥–µ–ª–∏

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

#### 1. **teams** ‚Äî –ö–æ–º–∞–Ω–¥—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Ö–∞–∫–∞—Ç–æ–Ω–∞
```python
class Team(Base):
    client_id: str          # team200, team201, etc.
    client_secret: str      # –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    team_name: str          # –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
    is_active: bool         # –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ –∫–æ–º–∞–Ω–¥–∞
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ credentials –ø—Ä–∏ `POST /auth/bank-token`
- –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã –≤ –º–µ–∂–±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö

#### 2. **clients** ‚Äî –ö–ª–∏–µ–Ω—Ç—ã –±–∞–Ω–∫–∞
```python
class Client(Base):
    person_id: str          # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∫–ª–∏–µ–Ω—Ç–∞ (team200-1, demo-client-001)
    client_type: str        # individual / legal
    full_name: str          # –§–ò–û –∫–ª–∏–µ–Ω—Ç–∞
    segment: str            # employee, student, entrepreneur
    monthly_income: Decimal # –î–æ—Ö–æ–¥
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
- –°–≤—è–∑—å —Å accounts, consents, payments

#### 3. **accounts** ‚Äî –°—á–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
```python
class Account(Base):
    client_id: int          # FK ‚Üí clients.id
    account_number: str     # –ù–æ–º–µ—Ä —Å—á–µ—Ç–∞ (40817810200000000001)
    account_type: str       # checking, savings, deposit
    balance: Decimal        # –ë–∞–ª–∞–Ω—Å —Å—á–µ—Ç–∞
    currency: str           # RUB, USD, EUR
    status: str             # active, closed, frozen
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—á–µ—Ç–æ–≤ –≤ API `/accounts`
- –†–∞—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–æ–≤ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

#### 4. **consents** ‚Äî –°–æ–≥–ª–∞—Å–∏—è –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º
```python
class Consent(Base):
    consent_id: str         # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–æ–≥–ª–∞—Å–∏—è
    client_id: int          # FK ‚Üí clients.id
    granted_to: str         # –ö–æ–¥ –±–∞–Ω–∫–∞, –∫–æ—Ç–æ—Ä–æ–º—É –≤—ã–¥–∞–Ω –¥–æ—Å—Ç—É–ø (team200)
    permissions: List[str]  # ReadAccountsDetail, ReadBalances, etc.
    status: str             # active, Revoked
    expiration_date_time: datetime
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∏ –º–µ–∂–±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–≥–ª–∞—Å–∏–π

#### 5. **consent_requests** ‚Äî –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ —Å–æ–≥–ª–∞—Å–∏–µ
```python
class ConsentRequest(Base):
    request_id: str         # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–∞–ø—Ä–æ—Å–∞
    client_id: int          # FK ‚Üí clients.id
    requesting_bank: str    # –ö–æ–¥ –±–∞–Ω–∫–∞, –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—â–µ–≥–æ –¥–æ—Å—Ç—É–ø
    permissions: List[str]   # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã–µ –ø—Ä–∞–≤–∞
    status: str             # pending, approved, rejected
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Å–æ–≥–ª–∞—Å–∏–µ –æ—Ç –¥—Ä—É–≥–∏—Ö –±–∞–Ω–∫–æ–≤
- –û–∂–∏–¥–∞–Ω–∏–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–º –∏–ª–∏ –±–∞–Ω–∫–æ–º

#### 6. **payments** ‚Äî –ü–ª–∞—Ç–µ–∂–∏ –∏ –ø–µ—Ä–µ–≤–æ–¥—ã
```python
class Payment(Base):
    payment_id: str         # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–ª–∞—Ç–µ–∂–∞
    account_id: int         # FK ‚Üí accounts.id
    amount: Decimal         # –°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞
    destination_account: str # –°—á–µ—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª—è
    destination_bank: str   # –ë–∞–Ω–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è
    status: str             # AcceptedSettlementInProcess, Completed, Rejected
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π
- –ú–µ–∂–±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –ø–µ—Ä–µ–≤–æ–¥—ã

### –°—Ö–µ–º–∞ —Å–≤—è–∑–µ–π —Ç–∞–±–ª–∏—Ü

```
teams (1) ‚îÄ‚îÄ‚îê
            ‚îÇ
clients (1) ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ accounts (N)
              ‚îÇ
              ‚îú‚îÄ‚îÄ consents (N)
              ‚îÇ
              ‚îú‚îÄ‚îÄ consent_requests (N)
              ‚îÇ
              ‚îî‚îÄ‚îÄ payments (N)

accounts (1) ‚îÄ‚îÄ transactions (N)
accounts (1) ‚îÄ‚îÄ payments (N)
```

---

## üîå API Endpoints –∏ –∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (`/auth/*`)

#### `POST /auth/bank-token`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API –±–∞–Ω–∫–∞

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `client_id` (query) ‚Äî ID –∫–æ–º–∞–Ω–¥—ã (team200)
- `client_secret` (query) ‚Äî –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –∫–æ–º–∞–Ω–¥—ã

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç credentials –≤ —Ç–∞–±–ª–∏—Ü–µ `teams`
2. –°–æ–∑–¥–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω (HS256)
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–∫–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `Authorization: Bearer ...`

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
- –ö–æ–º–∞–Ω–¥–∞–º–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ API –±–∞–Ω–∫–∞
- –ú–µ–∂–±–∞–Ω–∫–æ–≤—Å–∫–∏–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏ —á–µ—Ä–µ–∑ `/multibank/bank-token`

#### `POST /auth/login`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –í—Ö–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `username` ‚Äî person_id –∫–ª–∏–µ–Ω—Ç–∞ (team200-1, demo-client-001)
- `password` ‚Äî –ø–∞—Ä–æ–ª—å –∫–ª–∏–µ–Ω—Ç–∞

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ù–∞—Ö–æ–¥–∏—Ç –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ `person_id`
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–∞—Ä–æ–ª—å (–¥–ª—è team* –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `client_secret` –∏–∑ teams)
3. –°–æ–∑–¥–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–∫–µ–Ω –¥–ª—è Client UI

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
- Frontend: `/client/index.html` ‚Üí `/client/dashboard.html`

### –°—á–µ—Ç–∞ (`/accounts/*`)

#### `GET /accounts`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å—á–µ—Ç–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞

**–î–≤–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã:**

**1. –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç:**
```
Headers:
  Authorization: Bearer {client_token}
```
- –ß–∏—Ç–∞–µ—Ç —Å—á–µ—Ç–∞ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
- –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ `client_id` –∏–∑ —Ç–æ–∫–µ–Ω–∞

**2. –ú–µ–∂–±–∞–Ω–∫–æ–≤—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å:**
```
Headers:
  Authorization: Bearer {bank_token}
  x-consent-id: {consent_id}
  x-requesting-bank: {team_client_id}
Params:
  client_id: {person_id}
```
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–≥–ª–∞—Å–∏–µ —á–µ—Ä–µ–∑ `ConsentService.check_consent()`
- –ï—Å–ª–∏ —Å–æ–≥–ª–∞—Å–∏–µ –µ—Å—Ç—å ‚Üí —á–∏—Ç–∞–µ—Ç —Å—á–µ—Ç–∞ –∏–∑ –ë–î
- –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 403 CONSENT_REQUIRED

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
- Client UI –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—á–µ—Ç–æ–≤
- –ú–µ–∂–±–∞–Ω–∫–æ–≤—Å–∫–∏–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏ —á–µ—Ä–µ–∑ `/multibank/accounts-with-consent`

#### `GET /accounts/{account_id}/balances`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —Å—á–µ—Ç–∞

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (—Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –∏–ª–∏ —Å–æ–≥–ª–∞—Å–∏–µ)
2. –ß–∏—Ç–∞–µ—Ç –±–∞–ª–∞–Ω—Å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `accounts`
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ OpenBanking Russia

### –°–æ–≥–ª–∞—Å–∏—è (`/account-consents/*`)

#### `POST /account-consents/request`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–æ–≥–ª–∞—Å–∏–µ –æ—Ç –¥—Ä—É–≥–æ–≥–æ –±–∞–Ω–∫–∞

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `client_id` ‚Äî ID –∫–ª–∏–µ–Ω—Ç–∞
- `requesting_bank` ‚Äî –ö–æ–¥ –±–∞–Ω–∫–∞, –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—â–µ–≥–æ –¥–æ—Å—Ç—É–ø
- `permissions` ‚Äî –°–ø–∏—Å–æ–∫ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –°–æ–∑–¥–∞–µ—Ç `ConsentRequest` –≤ –ë–î
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫—É `auto_approve_consents`
3. –ï—Å–ª–∏ `auto_approve = true` ‚Üí —Å—Ä–∞–∑—É —Å–æ–∑–¥–∞–µ—Ç `Consent`
4. –ï—Å–ª–∏ `auto_approve = false` ‚Üí —Å–æ–∑–¥–∞–µ—Ç pending –∑–∞–ø—Ä–æ—Å

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
- –ú–µ–∂–±–∞–Ω–∫–æ–≤—Å–∫–∏–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏ —á–µ—Ä–µ–∑ `/multibank/request-consent`
- –î—Ä—É–≥–∏–º–∏ –±–∞–Ω–∫–∞–º–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞

#### `POST /account-consents/sign`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ —Å–æ–≥–ª–∞—Å–∏—è –∫–ª–∏–µ–Ω—Ç–æ–º

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `request_id` ‚Äî ID –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–æ–≥–ª–∞—Å–∏–µ
- `action` ‚Äî approve / reject
- `signature` ‚Äî –ü–æ–¥–ø–∏—Å—å –∫–ª–∏–µ–Ω—Ç–∞ (–ø–∞—Ä–æ–ª—å)

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ù–∞—Ö–æ–¥–∏—Ç `ConsentRequest` –ø–æ ID
2. –ï—Å–ª–∏ `action = approve` ‚Üí —Å–æ–∑–¥–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–π `Consent`
3. –ï—Å–ª–∏ `action = reject` ‚Üí –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
- Client UI: `/client/consents.html`

### –ú–µ–∂–±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã (`/multibank/*`)

#### `POST /multibank/bank-token`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ –±–∞–Ω–∫–∞

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `bank_url` ‚Äî URL –≤–Ω–µ—à–Ω–µ–≥–æ –±–∞–Ω–∫–∞

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `TEAM_CLIENT_ID` –∏ `TEAM_CLIENT_SECRET` –∏–∑ config
2. –î–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ `{bank_url}/auth/bank-token`
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–∫–µ–Ω –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
- Frontend: `dashboard.html` ‚Üí `loadBankAccounts()`

#### `POST /multibank/request-consent`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ó–∞–ø—Ä–æ—Å —Å–æ–≥–ª–∞—Å–∏—è —É –≤–Ω–µ—à–Ω–µ–≥–æ –±–∞–Ω–∫–∞

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `bank_url` ‚Äî URL –≤–Ω–µ—à–Ω–µ–≥–æ –±–∞–Ω–∫–∞
- `bank_token` ‚Äî –¢–æ–∫–µ–Ω –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ –±–∞–Ω–∫–∞
- `client_id` ‚Äî ID –∫–ª–∏–µ–Ω—Ç–∞ –≤ —Ü–µ–ª–µ–≤–æ–º –±–∞–Ω–∫–µ

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –î–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ `{bank_url}/account-consents/request`
2. –ü–µ—Ä–µ–¥–∞–µ—Ç `x-requesting-bank: {TEAM_CLIENT_ID}`
3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `consent_id` –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

#### `POST /multibank/accounts-with-consent`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—á–µ—Ç–æ–≤ –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ –±–∞–Ω–∫–∞ —Å —Å–æ–≥–ª–∞—Å–∏–µ–º

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `bank_url` ‚Äî URL –≤–Ω–µ—à–Ω–µ–≥–æ –±–∞–Ω–∫–∞
- `bank_token` ‚Äî –¢–æ–∫–µ–Ω –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ –±–∞–Ω–∫–∞
- `consent_id` ‚Äî ID —Å–æ–≥–ª–∞—Å–∏—è
- `client_id` ‚Äî ID –∫–ª–∏–µ–Ω—Ç–∞

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –î–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ `{bank_url}/accounts?client_id={client_id}`
2. –ü–µ—Ä–µ–¥–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏:
   - `Authorization: Bearer {bank_token}`
   - `x-consent-id: {consent_id}`
   - `x-requesting-bank: {TEAM_CLIENT_ID}`
3. –í–Ω–µ—à–Ω–∏–π –±–∞–Ω–∫ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–≥–ª–∞—Å–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—á–µ—Ç–∞
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—É

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –§–∞–π–ª `.env`

–í—Å–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –∏–∑ `.env` —Ñ–∞–π–ª–∞ (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∏–∑ `.env.txt`).

#### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

```env
# === DATABASE ===
DATABASE_URL=postgresql+psycopg2://postgres:password@localhost:5432/dbname
# –ò–õ–ò –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
POSTGRES_USER=postgres
POSTGRES_PASSWORD=your_password
POSTGRES_DB=vtbhack_db
POSTGRES_HOST=localhost
POSTGRES_PORT=5432

# === TEAM CREDENTIALS (–¥–ª—è –º–µ–∂–±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π) ===
TEAM_CLIENT_ID=team200
TEAM_CLIENT_SECRET=your_secret_key_from_organizers

# === SECURITY ===
SECRET_KEY=your-secret-key-change-in-production
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=1440

# === BANK IDENTIFICATION ===
BANK_CODE=vbank
BANK_NAME=Virtual Bank
BANK_DESCRIPTION=–û–ø–∏—Å–∞–Ω–∏–µ –±–∞–Ω–∫–∞

# === API ===
API_VERSION=2.1
REGISTRY_URL=http://localhost:3000
PUBLIC_URL=http://localhost:8001
```

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**1. `config.py`:**
```python
class BankConfig(BaseSettings):
    model_config = SettingsConfigDict(
        env_file=".env",           # –ß–∏—Ç–∞–µ—Ç –∏–∑ .env
        env_file_encoding="utf-8",
        extra="allow"              # –†–∞–∑—Ä–µ—à–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
    )
    
    # –í—Å–µ –ø–æ–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ .env
    TEAM_CLIENT_ID: Optional[str] = None
    TEAM_CLIENT_SECRET: Optional[str] = None
    # ...
```

**2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ:**
```python
from config import config

# –î–æ—Å—Ç—É–ø –∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º:
team_id = config.TEAM_CLIENT_ID
db_url = config.DATABASE_URL
```

**3. –í `database.py`:**
```python
from config import config
DATABASE_URL = config.DATABASE_URL  # –ò–∑ .env
```

**4. –í `api/multibank_proxy.py`:**
```python
from config import config
TEAM_CLIENT_ID = config.TEAM_CLIENT_ID or "team200"
TEAM_CLIENT_SECRET = config.TEAM_CLIENT_SECRET or "..."
```

---

## üîÑ –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö (Data Flow)

### –ü–æ—Ç–æ–∫ 1: –í—Ö–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç

```
1. Frontend (index.html)
   ‚îî‚îÄ> POST /auth/login {username, password}
       ‚îÇ
2. Backend (api/auth.py)
   ‚îî‚îÄ> –ü—Ä–æ–≤–µ—Ä–∫–∞ credentials
       ‚îú‚îÄ> –ù–∞–π—Ç–∏ Client –ø–æ person_id
       ‚îú‚îÄ> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞—Ä–æ–ª—å
       ‚îî‚îÄ> –°–æ–∑–¥–∞—Ç—å JWT —Ç–æ–∫–µ–Ω
           ‚îÇ
3. Frontend –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω
   ‚îî‚îÄ> –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ localStorage
       ‚îî‚îÄ> –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /client/dashboard.html
           ‚îÇ
4. Dashboard –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
   ‚îî‚îÄ> GET /accounts (—Å —Ç–æ–∫–µ–Ω–æ–º –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ)
       ‚îÇ
5. Backend (api/accounts.py)
   ‚îî‚îÄ> –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
       ‚îú‚îÄ> –ò–∑–≤–ª–µ—á—å client_id –∏–∑ —Ç–æ–∫–µ–Ω–∞
       ‚îî‚îÄ> –ß–∏—Ç–∞—Ç—å —Å—á–µ—Ç–∞ –∏–∑ –ë–î
           ‚îÇ
6. Frontend –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å—á–µ—Ç–∞
```

### –ü–æ—Ç–æ–∫ 2: –ó–∞–≥—Ä—É–∑–∫–∞ —Å—á–µ—Ç–æ–≤ –∏–∑ –¥—Ä—É–≥–æ–≥–æ –±–∞–Ω–∫–∞

```
1. Frontend (dashboard.html)
   ‚îî‚îÄ> loadAllBanks()
       ‚îÇ
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∞–Ω–∫–∞:
   ‚îÇ
   ‚îú‚îÄ> –®–ê–ì 1: –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω
   ‚îÇ   ‚îî‚îÄ> POST /multibank/bank-token {bank_url}
   ‚îÇ       ‚îÇ
   ‚îÇ   Backend (multibank_proxy.py)
   ‚îÇ   ‚îî‚îÄ> POST {bank_url}/auth/bank-token
   ‚îÇ       Params: client_id={TEAM_CLIENT_ID}, 
   ‚îÇ               client_secret={TEAM_CLIENT_SECRET}
   ‚îÇ       ‚îÇ
   ‚îÇ   –í–Ω–µ—à–Ω–∏–π –±–∞–Ω–∫ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç credentials
   ‚îÇ   ‚îî‚îÄ> –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç bank_token
   ‚îÇ
   ‚îú‚îÄ> –®–ê–ì 2: –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ
   ‚îÇ   ‚îî‚îÄ> POST /multibank/request-consent
   ‚îÇ       {bank_url, bank_token, client_id}
   ‚îÇ       ‚îÇ
   ‚îÇ   Backend (multibank_proxy.py)
   ‚îÇ   ‚îî‚îÄ> POST {bank_url}/account-consents/request
   ‚îÇ       Headers: Authorization: Bearer {bank_token}
   ‚îÇ               x-requesting-bank: {TEAM_CLIENT_ID}
   ‚îÇ       ‚îÇ
   ‚îÇ   –í–Ω–µ—à–Ω–∏–π –±–∞–Ω–∫ —Å–æ–∑–¥–∞–µ—Ç ConsentRequest
   ‚îÇ   ‚îî‚îÄ> –ï—Å–ª–∏ auto_approve ‚Üí —Å–æ–∑–¥–∞–µ—Ç Consent
   ‚îÇ       ‚îî‚îÄ> –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç consent_id
   ‚îÇ
   ‚îî‚îÄ> –®–ê–ì 3: –ü–æ–ª—É—á–∏—Ç—å —Å—á–µ—Ç–∞
       ‚îî‚îÄ> POST /multibank/accounts-with-consent
           {bank_url, bank_token, consent_id, client_id}
           ‚îÇ
       Backend (multibank_proxy.py)
       ‚îî‚îÄ> GET {bank_url}/accounts?client_id={client_id}
           Headers: Authorization: Bearer {bank_token}
                   x-consent-id: {consent_id}
                   x-requesting-bank: {TEAM_CLIENT_ID}
           ‚îÇ
       –í–Ω–µ—à–Ω–∏–π –±–∞–Ω–∫ (accounts.py)
       ‚îî‚îÄ> –ü—Ä–æ–≤–µ—Ä—è–µ—Ç Consent —á–µ—Ä–µ–∑ ConsentService
           ‚îú‚îÄ> –ï—Å–ª–∏ –µ—Å—Ç—å ‚Üí —á–∏—Ç–∞–µ—Ç —Å—á–µ—Ç–∞ –∏–∑ –ë–î
           ‚îî‚îÄ> –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí 403 CONSENT_REQUIRED
               ‚îÇ
       Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
       ‚îÇ
3. Frontend –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≤—Å–µ —Å—á–µ—Ç–∞ –∏–∑ –≤—Å–µ—Ö –±–∞–Ω–∫–æ–≤
```

### –ü–æ—Ç–æ–∫ 3: –ú–µ–∂–±–∞–Ω–∫–æ–≤—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å –∫ –≤–∞—à–µ–º—É –±–∞–Ω–∫—É

```
1. –í–Ω–µ—à–Ω–∏–π –±–∞–Ω–∫ –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
   ‚îî‚îÄ> GET https://your-bank.ru/accounts?client_id=team200-1
       Headers: Authorization: Bearer {bank_token}
               x-consent-id: {consent_id}
               x-requesting-bank: {team200}
       ‚îÇ
2. –í–∞—à –±–∞–Ω–∫ (api/accounts.py)
   ‚îî‚îÄ> –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —á—Ç–æ —ç—Ç–æ –º–µ–∂–±–∞–Ω–∫–æ–≤—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å
       (–ø–æ –Ω–∞–ª–∏—á–∏—é x-requesting-bank)
       ‚îÇ
   ‚îî‚îÄ> ConsentService.check_consent()
       ‚îú‚îÄ> –ù–∞–π—Ç–∏ Client –ø–æ person_id
       ‚îú‚îÄ> –ù–∞–π—Ç–∏ Consent –≥–¥–µ:
       ‚îÇ   - client_id = client.id
       ‚îÇ   - granted_to = x-requesting-bank
       ‚îÇ   - status = "active"
       ‚îÇ   - expiration_date_time > now()
       ‚îÇ   - permissions —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç—Ä–µ–±—É–µ–º—ã–µ
       ‚îÇ
       ‚îú‚îÄ> –ï—Å–ª–∏ Consent –Ω–∞–π–¥–µ–Ω:
       ‚îÇ   ‚îî‚îÄ> –ß–∏—Ç–∞—Ç—å —Å—á–µ—Ç–∞ –∏–∑ –ë–î
       ‚îÇ       ‚îî‚îÄ> –í–µ—Ä–Ω—É—Ç—å –¥–∞–Ω–Ω—ã–µ
       ‚îÇ
       ‚îî‚îÄ> –ï—Å–ª–∏ Consent –Ω–µ –Ω–∞–π–¥–µ–Ω:
           ‚îî‚îÄ> 403 CONSENT_REQUIRED
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### 1. –î–∞–Ω–Ω—ã–µ –ù–ï –∫—ç—à–∏—Ä—É—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ

**–í–∞–∂–Ω–æ**: –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—á–µ—Ç–æ–≤ –∏–∑ –¥—Ä—É–≥–∏—Ö –±–∞–Ω–∫–æ–≤ –¥–∞–Ω–Ω—ã–µ **–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è** –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î. –ö–∞–∂–¥—ã–π —Ä–∞–∑ –¥–µ–ª–∞–µ—Ç—Å—è —Å–≤–µ–∂–∏–π HTTP –∑–∞–ø—Ä–æ—Å –∫ –≤–Ω–µ—à–Ω–µ–º—É –±–∞–Ω–∫—É.

**–ü–æ—á–µ–º—É:**
- –î–∞–Ω–Ω—ã–µ –≤—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ
- –ù–µ –Ω—É–∂–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç OpenBanking –ø—Ä–∏–Ω—Ü–∏–ø–∞–º

### 2. –°–æ–≥–ª–∞—Å–∏—è (Consents) —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î –±–∞–Ω–∫–∞-–≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–∞–Ω–Ω—ã—Ö

–ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ `team200` –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ `vbank`:
- –°–æ–≥–ª–∞—Å–∏–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∏ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î `vbank`
- `team200` –Ω–µ —Ö—Ä–∞–Ω–∏—Ç —Å–æ–≥–ª–∞—Å–∏–µ —É —Å–µ–±—è
- –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ `vbank` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–≥–ª–∞—Å–∏–µ –≤ —Å–≤–æ–µ–π –ë–î

### 3. TEAM_CLIENT_ID –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—â–µ–π —Å—Ç–æ—Ä–æ–Ω—ã

–í –∑–∞–≥–æ–ª–æ–≤–∫–µ `x-requesting-bank` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è `TEAM_CLIENT_ID`:
- –ë–∞–Ω–∫ –∑–Ω–∞–µ—Ç, –∫—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
- –ú–æ–∂–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã
- –ú–æ–∂–µ—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å —Ä–∞–∑–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞

### 4. –ê–≤—Ç–æ–æ–¥–æ–±—Ä–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–∏–π

–í —Ç–∞–±–ª–∏—Ü–µ `bank_settings` –µ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ `auto_approve_consents`:
- –ï—Å–ª–∏ `true` ‚Üí —Å–æ–≥–ª–∞—Å–∏—è –æ–¥–æ–±—Ä—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ï—Å–ª–∏ `false` ‚Üí —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–æ–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ —á–µ—Ä–µ–∑ UI

**–ì–¥–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è:**
- –ß–µ—Ä–µ–∑ Banker UI: `/banker/consents.html`
- –ß–µ—Ä–µ–∑ SQL: `UPDATE bank_settings SET value='true' WHERE key='auto_approve_consents'`

### 5. –§–æ—Ä–º–∞—Ç URL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:
- `postgresql://user:pass@host:port/db`
- `postgresql+psycopg2://user:pass@host:port/db`
- `postgresql+asyncpg://user:pass@host:port/db`

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ `postgresql+asyncpg://` –¥–ª—è async –æ–ø–µ—Ä–∞—Ü–∏–π.

### 6. JWT —Ç–æ–∫–µ–Ω—ã

**Team tokens** (HS256):
- –ü—Ä–æ—â–µ –¥–ª—è sandbox
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SECRET_KEY –∏–∑ config
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ `jwt.decode(token, SECRET_KEY)`

**Bank tokens** (RS256):
- –î–ª—è production (–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ sandbox)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –±–∞–Ω–∫–∞
- –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –≤ `/.well-known/jwks.json`

### 7. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ API –≤—ã–∑–æ–≤–æ–≤

–í—Å–µ API –≤—ã–∑–æ–≤—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `api_calls_log`:
- URL –∑–∞–ø—Ä–æ—Å–∞
- –ú–µ—Ç–æ–¥ (GET, POST, etc.)
- –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- IP –∞–¥—Ä–µ—Å

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:**
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- –û—Ç–ª–∞–¥–∫–∏
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∏

### 8. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
bank-in-a-box/
‚îú‚îÄ‚îÄ api/              # API endpoints
‚îÇ   ‚îú‚îÄ‚îÄ auth.py       # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ accounts.py   # –°—á–µ—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ consents.py   # –°–æ–≥–ª–∞—Å–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ multibank_proxy.py  # –ú–µ–∂–±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ services/         # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ auth_service.py
‚îÇ   ‚îú‚îÄ‚îÄ consent_service.py
‚îÇ   ‚îî‚îÄ‚îÄ payment_service.py
‚îú‚îÄ‚îÄ models.py        # SQLAlchemy –º–æ–¥–µ–ª–∏
‚îú‚îÄ‚îÄ database.py      # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
‚îú‚îÄ‚îÄ config.py        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ main.py          # FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ frontend/        # UI
‚îÇ   ‚îú‚îÄ‚îÄ client/      # –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
‚îÇ   ‚îî‚îÄ‚îÄ banker/      # –ö–∞–±–∏–Ω–µ—Ç –±–∞–Ω–∫–∏—Ä–∞
‚îî‚îÄ‚îÄ shared/
    ‚îî‚îÄ‚îÄ database/
        ‚îî‚îÄ‚îÄ init.sql # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
```

---

## üìù –†–µ–∑—é–º–µ

### –ì–ª–∞–≤–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:

1. **TEAM_CLIENT_ID –∏ TEAM_CLIENT_SECRET** ‚Äî credentials –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —É—á–∞—Å—Ç–∏—è –≤ —Ö–∞–∫–∞—Ç–æ–Ω–µ
   - –•—Ä–∞–Ω—è—Ç—Å—è –≤ `.env` –∏ —Ç–∞–±–ª–∏—Ü–µ `teams`
   - –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –æ—Ç –¥—Ä—É–≥–∏—Ö –±–∞–Ω–∫–æ–≤
   - –ü–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `x-requesting-bank`

2. **–î–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è —á–µ—Ä–µ–∑ API –∑–∞–ø—Ä–æ—Å—ã**, –∞ –Ω–µ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î
   - –ö–∞–∂–¥—ã–π –±–∞–Ω–∫ —Ö—Ä–∞–Ω–∏—Ç —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
   - –î–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ OpenBanking API —Å —Å–æ–≥–ª–∞—Å–∏–µ–º –∫–ª–∏–µ–Ω—Ç–∞

3. **–°–æ–≥–ª–∞—Å–∏—è (Consents)** ‚Äî –∫–ª—é—á–µ–≤–æ–π –º–µ—Ö–∞–Ω–∏–∑–º –¥–æ—Å—Ç—É–ø–∞
   - –°–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –¥–æ—Å—Ç—É–ø–∞
   - –•—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î –±–∞–Ω–∫–∞-–≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–∞–Ω–Ω—ã—Ö
   - –ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ

4. **–¢—Ä–∏ —Ç–∏–ø–∞ —Ç–æ–∫–µ–Ω–æ–≤:**
   - Team token ‚Äî –¥–ª—è –∫–æ–º–∞–Ω–¥ (–º–µ–∂–±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã)
   - Client token ‚Äî –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ (–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç)
   - Banker token ‚Äî –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–Ω–∫–æ–º)

5. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ `.env`** ‚Äî –≤—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ

---

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞:** 2025-01-XX  
**–í–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞:** 2.1  
**–ê–≤—Ç–æ—Ä:** Bank-in-a-Box Team

