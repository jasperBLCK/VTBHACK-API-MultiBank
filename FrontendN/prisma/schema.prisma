// Prisma schema для мультибанка
// База данных: SQLite для разработки/демо, PostgreSQL для продакшена

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite" // Для демо используем SQLite, для продакшена - PostgreSQL
  url      = env("DATABASE_URL")
  // Для PostgreSQL раскомментируйте следующую строку и закомментируйте provider = "sqlite"
  // provider = "postgresql"
}

// Пользователь
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Связи
  bankConnections BankConnection[]
  accounts        Account[]
  transactions    Transaction[]
  settings        UserSettings?
  notifications   Notification[]
  budgets         Budget[]

  @@map("users")
}

// Подключения к банкам
model BankConnection {
  id        String   @id @default(cuid())
  userId    String
  bankName  String   // ВТБ, Сбербанк, Альфа-Банк и т.д.
  bankId    String   // Уникальный идентификатор банка
  accessToken String // Зашифрованный токен доступа (SQLite не поддерживает @db.Text)
  refreshToken String? // Refresh token если доступен
  expiresAt DateTime? // Время истечения токена
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Связи
  user    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accounts Account[]

  @@unique([userId, bankId])
  @@map("bank_connections")
}

// Банковские счета
model Account {
  id            String   @id @default(cuid())
  userId        String
  bankConnectionId String?
  bankName      String
  accountNumber String
  balance       Float    @default(0) // SQLite использует Float вместо Decimal
  currency      String   @default("RUB")
  type          String   // debit, credit, savings и т.д.
  lastSyncedAt  DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Связи
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  bankConnection BankConnection? @relation(fields: [bankConnectionId], references: [id], onDelete: SetNull)
  transactions  Transaction[]

  @@index([userId])
  @@index([bankConnectionId])
  @@map("accounts")
}

// Транзакции
model Transaction {
  id          String   @id @default(cuid())
  userId      String
  accountId   String
  amount      Float    // SQLite использует Float вместо Decimal
  currency    String   @default("RUB")
  description String?
  category    String   @default("other") // income, shopping, food, transport, bills, other
  type        String?  // transfer, payment, income и т.д.
  date        DateTime
  toAccountId String?  // Для переводов
  metadata    String?  // Дополнительные данные в формате JSON (SQLite не поддерживает Json напрямую)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Связи
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([accountId])
  @@index([date])
  @@map("transactions")
}

// Бюджеты
model Budget {
  id        String   @id @default(cuid())
  userId    String
  category  String   // food, transport, shopping, bills и т.д.
  amount    Float
  period    String   // monthly, yearly
  startDate DateTime
  endDate   DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Связи
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([category])
  @@map("budgets")
}

// Настройки пользователя
model UserSettings {
  id        String   @id @default(cuid())
  userId    String   @unique
  theme     String   @default("light") // light, dark
  language  String   @default("ru")
  currency  String   @default("RUB")
  notificationsEnabled Boolean @default(true)
  autoSync  Boolean  @default(true)
  syncInterval Int   @default(3600) // Интервал синхронизации в секундах
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Связи
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

// Уведомления
model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // success, error, info, warning
  title     String
  message   String
  isRead    Boolean  @default(false)
  readAt    DateTime?
  createdAt DateTime @default(now())

  // Связи
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}
